name: Update GuangdongIPTV m3u File

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨ 02:00 è¿è¡Œ
    - cron: '0 2 * * 1'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨ä» Actions æ ‡ç­¾é¡µè§¦å‘
    
env:
  UDPXY_IP_ADDRESS: "172.17.0.2"
  UDPXY_PORT: "7878"
  
jobs:
  update-file:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout *your* repository
        # æ£€å‡ºæ‚¨çš„ç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          path: './my-repo-checkout'

      - name: Checkout source repository (Tzwcard)
        # æ£€å‡ºæºä»“åº“åˆ°å¦ä¸€ä¸ªç›®å½•
        uses: actions/checkout@v4
        with:
          repository: 'Tzwcard/ChinaTelecom-GuangdongIPTV-RTP-List'
          path: './source-repo'
          # ä¸éœ€è¦ tokenï¼Œå› ä¸ºå®ƒæ˜¯å…¬å…±ä»“åº“

      - name: Copy target file to working directory
        # å°†æ–‡ä»¶ä»æºç›®å½•å¤åˆ¶åˆ°æˆ‘ä»¬æ£€å‡ºè‡ªå·±ä»“åº“çš„ç›®å½•
        run: |
          cp ./source-repo/*.m3u ./my-repo-checkout/

      - name: Modify rtp addresses
        # åœ¨æ‚¨çš„ä»“åº“ç›®å½•ä¸­ä¿®æ”¹æ–‡ä»¶
        run: |
          sed -i 's|rtp://|http://${{ env.UDPXY_IP_ADDRESS }}:${{ env.UDPXY_PORT }}/rtp/|g' ./my-repo-checkout/*.m3u

      - name: update iptv-api gat playlist
        # æ›´æ–°æ¸¯æ¾³å°æ’­æ”¾æ¸…å•
        run: |
          curl -L "https://raw.githubusercontent.com/Guovin/iptv-api/refs/heads/gd/output/result.m3u" | \
          awk 'BEGIN {print "#EXTM3U"} /group-title="ğŸŒŠæ¸¯Â·æ¾³Â·å°"/ {print; getline; print}' > ./my-repo-checkout/iptv-gat.m3u


      - name: Commit and push changes
        # ä½¿ç”¨ git-auto-commit-action æäº¤æ‚¨çš„ä»“åº“ç›®å½•ä¸­çš„æ›´æ”¹
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update m3u with udpxy URLs"
          branch: main # æˆ–æ‚¨çš„é»˜è®¤åˆ†æ”¯åç§°
          # æŒ‡å®š auto-commit-action åœ¨å“ªé‡ŒæŸ¥æ‰¾æ›´æ”¹
          repository: './my-repo-checkout'
